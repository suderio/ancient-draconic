# Task: Architecture Pivot to Data-Driven Game Engine

- [x] Phase 1: Infrastructure & Environment Setup
  - [x] Add `google/cel-go` dependency
  - [x] Create `internal/rules` package for CEL initialization
  - [x] Implement `roll()` custom function for CEL
- [x] Phase 2: Core Data Model Refactor
  - [x] Update `engine.Entity` to generic map-based stats
  - [x] Implement `Ability` and `Action` models with CEL support
  - [x] Refactor `data.Loader` to populate generic structs
- [x] Phase 3: Rule Evaluation Bridge
  - [x] Implement `EvalRule` in the engine
  - [x] Create context binding for CEL (actor, target, action)
  - [x] Refactor `attack` command to use CEL formulas
  - [x] Refactor `check` command to use CEL formulas
- [x] Phase 4: System Manifest & Extensibility
  - [x] Implement `CampaignManifest` (global rules/formulas)
  - [x] Dynamic command registration in the manifest
  - [x] Generic Command Executor (`ExecuteGenericCommand`)
  - [x] Unified mapping logic for complex events (Attack/Check)
  - [x] Automated Help action consumption via CEL
- [x] Phase 5: Cleanup & Verification
  - [x] Remove hard-coded D&D logic (`attack.go`, `check.go`)
  - [x] Update and verify full integration test suite
  - [x] Final architecture walkthrough
- [x] Phase 6: Migration of Damage and Turn Commands
  - [x] Manifest-driven damage calculation (resistances/vulnerabilities)
  - [x] Manifest-driven turn rotation and state cleanup
- [x] Phase 7: Migration of Grapple and Shove Commands
  - [x] Size-rank comparison logic in CEL
  - [x] Adjudication flow for special maneuvers
- [x] Phase 8: Migration of Dodge and Initiative Commands
  - [x] Condition-aware attack formulas (Dodging disadvantage)
  - [x] Manifest-driven initiative rolls
- [x] Phase 9: Migration of Utility and Encounter Commands
  - [x] Implement `help_action`, `ask`, `encounter`, and `add` in manifest
  - [x] Update `check` command for dynamic DC resolution
  - [x] Delete legacy command implementations and refactor tests
- [/] Phase 10: Truly Generic Engine Architecture
  - [x] Implementation Plan for generic engine
  - [ ] Redefine `Entity` and `GameState` structures
  - [ ] Implement generic `engine.Event` system and manifest-driven `Apply`
  - [ ] Implement generic `freeze` mechanism with `unfreeze_condition`
  - [ ] Refactor `opportunity` and `off-hand` attacks as separate commands
  - [ ] Move `adjudicate`, `help`, and `hint` to manifest
  - [ ] Comprehensive dead code cleanup

- [x] Phase 11: Game Loop & Resource Agnosticism
  - [x] Create implementation plan (`docs/plan_phase_11_game_loop.md`)
  - [x] Refactor engine generic events to remove D&D specific ones
  - [x] Implement `start_turn` and `end_turn` workflow in manifest
  - [x] Migrate condition duration tracking (like Dodge/Help) to generic logic
  - [x] Verify combat loops and resource resets in integration tests

- [/] Phase 12: Generic Opposed Rolls & Choice Issuance
  - [x] Plan engine improvements for PDQ and D&D (`docs/plan_pdq_support.md`)
  - [x] Implement `ChoiceIssuedEvent` for dynamic target selections (e.g. Smites, Qualities)
  - [x] Implement `ContestStartedEvent` for opposed rolls (e.g. Athletics vs Acrobatics)
  - [x] Update D&D Manifest to utilize `ChoiceIssuedEvent` and `ContestStartedEvent`
  - [x] Verify functionality via integration tests for PDQ damage application and D&D grapple resisting

- [x] Phase 13: Generic AST Parser & Dynamic TUI
  - [x] Plan generic AST refactoring (`docs/plan_generic_parser.md`)
  - [x] Refactor Lexer & AST layers to support `GenericCmd`
  - [x] Refactor `session.go` to execute `GenericCmd` directly through `manifest.Commands`
  - [x] Refactor `tui.go` to pull auto-complete suggestions dynamically from the loaded manifest

- [ ] Phase 14: Decoupling Engine Events
  - [ ] Draft Implementation Plan (`docs/plan_phase_14_event_decoupling.md`)
  - [ ] Remove `HPChanged`, `AttackResolved`, and `InitiativeRolled` events from `engine/event.go`.
  - [ ] Add `TurnOrderUpdatedEvent` to `engine/event.go`.
  - [ ] Update `executor.go` to remove specialized dispatching for deleted events.
  - [ ] Rewrite `attack`, `damage`, and `initiative` commands in `manifest.yaml` using CEL.
  - [ ] Fix integration tests to expect the generic event equivalents (`AttributeChangedEvent`, `MetadataChangedEvent`).
